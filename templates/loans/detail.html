{% extends "base.html" %}
{% block title %}Loan Details - Banking System{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center pt-3 pb-2 mb-3 border-bottom">
  <h1 class="h2"><i class="fas fa-file-invoice-dollar me-2"></i>Loan #{{ loan.id }}</h1>
  <div>
    <a href="{{ url_for('loans') }}" class="btn btn-outline-secondary me-2"><i class="fas fa-arrow-left me-2"></i>Back</a>
    {% if loan.loan_status == 'completed' %}
      <a href="{{ url_for('cert_loan_completion', loan_id=loan.id) }}" class="btn btn-primary"><i class="fas fa-certificate me-2"></i>Download Completion Certificate</a>
    {% endif %}
  </div>
</div>
<div class="row g-3">
  <div class="col-md-6">
    <div class="card"><div class="card-body">
      <h5 class="mb-3">Summary</h5>
      <div class="row mb-2"><div class="col-5 text-muted">Customer</div><div class="col-7">{{ customer.full_name }}</div></div>
      <div class="row mb-2"><div class="col-5 text-muted">Amount</div><div class="col-7">₹{{ "{:,.2f}".format(loan.loan_amount) }}</div></div>
      <div class="row mb-2"><div class="col-5 text-muted">Interest</div><div class="col-7">{{ loan.interest_rate }}%</div></div>
      <div class="row mb-2"><div class="col-5 text-muted">Tenure</div><div class="col-7">{{ loan.tenure_months }} months</div></div>
      <div class="row mb-2"><div class="col-5 text-muted">EMI</div><div class="col-7">₹{{ "{:,.2f}".format(loan.emi_amount) }}</div></div>
      <div class="row mb-2"><div class="col-5 text-muted">Outstanding</div><div class="col-7">₹{{ "{:,.2f}".format(loan.total_outstanding) }}</div></div>
      <div class="row"><div class="col-5 text-muted">Period</div><div class="col-7">{{ loan.disbursement_date }} → {{ loan.maturity_date }}</div></div>
    </div></div>
  </div>
  <div class="col-md-6">
    <div class="card"><div class="card-body">
      <h5 class="mb-3">Guarantors</h5>
      {% for g in guarantors %}
      <div class="border rounded p-2 mb-2">
        <div class="small text-muted mb-1">Guarantor {{ g.guarantor_type }}</div>
        <div><strong>{{ g.guarantor_name }}</strong> · {{ g.guarantor_aadhaar }}</div>
        <div class="text-muted">{{ g.guarantor_address }} · {{ g.guarantor_phone or '-' }}</div>
      </div>
      {% endfor %}
    </div></div>
  </div>
</div>
<div class="card mt-3"><div class="card-body">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h5 class="mb-0">EMI Schedule</h5>
    <form method="POST" action="{{ url_for('collect_emi', loan_id=loan.id) }}">
      <button type="submit" class="btn btn-sm btn-primary"><i class="fas fa-receipt me-2"></i>Post Monthly EMI</button>
    </form>
  </div>
  {% if payments %}
  <div class="table-responsive">
    <table class="table table-striped" id="emi-table">
      <thead><tr>
        <th>#</th><th>Date</th><th>EMI</th><th>Interest</th><th>Principal</th><th>Outstanding</th><th>Status</th>
      </tr></thead>
      <tbody>
        {% for p in payments %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ p.payment_date }}</td>
          <td>₹{{ "{:,.2f}".format(p.emi_amount) }}</td>
          <td>₹{{ "{:,.2f}".format(p.interest_amount) }}</td>
          <td>₹{{ "{:,.2f}".format(p.principal_amount) }}</td>
          <td>₹{{ "{:,.2f}".format(p.outstanding_after_payment) }}</td>
          <td>{{ p.payment_status }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
    <p class="text-muted mb-0">No EMIs posted yet. Use "Post Monthly EMI" to process this month.</p>
  {% endif %}
</div></div>
{% endblock %}